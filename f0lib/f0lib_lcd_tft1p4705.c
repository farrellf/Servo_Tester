// Written by Farrell Farahbod
// Last revised on 2014-07-01
// This file is released into the public domain

#include "f0lib_lcd_tft1p4705.h"

enum GPIO_PORT data_port;
enum GPIO_PIN cs;
enum GPIO_PIN rs;
enum GPIO_PIN wr;
enum GPIO_PIN rd;
enum GPIO_PIN reset;

// A fixed-width font with characters 8px wide and 16px tall
const uint16_t font_8x16[91][8] = {
	{0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // ASCII 32, space
	{0b0000000000000000,0b0000000000000000,0b0011111111001100,0b0011111111001100,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // !
	{0b0011111100000000,0b0011111100000000,0b0000000000000000,0b0000000000000000,0b0011111100000000,0b0011111100000000,0b0000000000000000,0b0000000000000000}, // "
	{0b0000110000110000,0b0011111111111100,0b0011111111111100,0b0000110000110000,0b0011111111111100,0b0011111111111100,0b0000110000110000,0b0000000000000000}, // #
	{0b0001110000110000,0b0011111000110000,0b1111011100111100,0b1111001110111100,0b0011000111110000,0b0011000011100000,0b0000000000000000,0b0000000000000000}, // $
	{0b0011110000001100,0b0011110000111100,0b0000000011110000,0b0000001111000000,0b0000111100000000,0b0011110000111100,0b0011000000111100,0b0000000000000000}, // %
	{0b0000000011111000,0b0111101111111100,0b1111111100001100,0b1100111111011100,0b1111110011110000,0b0111000011111100,0b0000000011001100,0b0000000000000000}, // &
	{0b0000000000000000,0b0000000000000000,0b0011111100000000,0b0011111100000000,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // '
	{0b0000000000000000,0b0000000000000000,0b0000111111110000,0b0001111111111000,0b0011100000011100,0b0011000000001100,0b0000000000000000,0b0000000000000000}, // (
	{0b0011000000001100,0b0011100000011100,0b0001111111111000,0b0000111111110000,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // )
	{0b0000001100000000,0b0011001100110000,0b0011111111110000,0b0000111111000000,0b0011111111110000,0b0011001100110000,0b0000001100000000,0b0000000000000000}, // *
	{0b0000001100000000,0b0000001100000000,0b0011111111110000,0b0011111111110000,0b0000001100000000,0b0000001100000000,0b0000000000000000,0b0000000000000000}, // +
	{0b0000000000000000,0b0000000000000011,0b0000000000111111,0b0000000000111100,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // ,
	{0b0000001100000000,0b0000001100000000,0b0000001100000000,0b0000001100000000,0b0000001100000000,0b0000001100000000,0b0000000000000000,0b0000000000000000}, // -
	{0b0000000000000000,0b0000000000000000,0b0000000000011100,0b0000000000011100,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // .
	{0b0000000000001100,0b0000000000111100,0b0000000011110000,0b0000001111000000,0b0000111100000000,0b0011110000000000,0b0011000000000000,0b0000000000000000}, // /
	{0b0001111111111000,0b0011111111111100,0b0011000000001100,0b0011000000001100,0b0011111111111100,0b0001111111111000,0b0000000000000000,0b0000000000000000}, // 0
	{0b0000000000001100,0b0000110000001100,0b0011111111111100,0b0011111111111100,0b0000000000001100,0b0000000000001100,0b0000000000000000,0b0000000000000000}, // 1
	{0b0001110000001100,0b0011110000111100,0b0011000011111100,0b0011001111001100,0b0011111100001100,0b0001110000001100,0b0000000000000000,0b0000000000000000}, // 2
	{0b0011000000111000,0b0011000000111100,0b0011001100001100,0b0011111111001100,0b0011110011111100,0b0011000000111000,0b0000000000000000,0b0000000000000000}, // 3
	{0b0000000011110000,0b0000001111110000,0b0000111100110000,0b0011111111111100,0b0011111111111100,0b0000000000110000,0b0000000000000000,0b0000000000000000}, // 4
	{0b0011111100111000,0b0011111100111100,0b0011001100001100,0b0011001110001100,0b0011000111111100,0b0011000011111000,0b0000000000000000,0b0000000000000000}, // 5
	{0b0001111111111000,0b0011111111111100,0b0011001100001100,0b0011001100001100,0b0011001111111100,0b0000000111111000,0b0000000000000000,0b0000000000000000}, // 6
	{0b0011000000000000,0b0011000000111100,0b0011000011111100,0b0011001111000000,0b0011111100000000,0b0011100000000000,0b0000000000000000,0b0000000000000000}, // 7
	{0b0001110011111000,0b0011111111111100,0b0011001100001100,0b0011001100001100,0b0011111111111100,0b0001110011111000,0b0000000000000000,0b0000000000000000}, // 8
	{0b0001111000000000,0b0011111100001100,0b0011001100001100,0b0011001100011000,0b0011111111111000,0b0001111111100000,0b0000000000000000,0b0000000000000000}, // 9
	{0b0000000000000000,0b0000011100111000,0b0000011100111000,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // :
	{0b0000000000000000,0b0000000000000011,0b0000111100111111,0b0000111100111100,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // ;
	{0b0000000000000000,0b0000001100000000,0b0000111111000000,0b0011110011110000,0b1111000000111100,0b1100000000001100,0b0000000000000000,0b0000000000000000}, // <
	{0b0000110000110000,0b0000110000110000,0b0000110000110000,0b0000110000110000,0b0000110000110000,0b0000110000110000,0b0000000000000000,0b0000000000000000}, // =
	{0b1100000000001100,0b1111000000111100,0b0011110011110000,0b0000111111000000,0b0000001100000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // >
	{0b0001110000000000,0b0011110000000000,0b0011000011001100,0b0011001111001100,0b0011111100000000,0b0001110000000000,0b0000000000000000,0b0000000000000000}, // ?
	{0b0001111111111000,0b0011111111111100,0b0011000000001100,0b0011001111001100,0b0011111111001100,0b0001111111001100,0b0000000000000000,0b0000000000000000}, // @
	{0b0000011111111100,0b0000111111111100,0b0011110000110000,0b0011110000110000,0b0000111111111100,0b0000011111111100,0b0000000000000000,0b0000000000000000}, // A
	{0b0011111111111100,0b0011111111111100,0b0011001100001100,0b0011001100001100,0b0011111111111100,0b0001110011111000,0b0000000000000000,0b0000000000000000}, // B
	{0b0001111111111000,0b0011111111111100,0b0011000000001100,0b0011000000001100,0b0011110000111100,0b0001110000111000,0b0000000000000000,0b0000000000000000}, // C
	{0b0011111111111100,0b0011111111111100,0b0011000000001100,0b0011100000011100,0b0001111111111000,0b0000011111100000,0b0000000000000000,0b0000000000000000}, // D
	{0b0011111111111100,0b0011111111111100,0b0011001100001100,0b0011001100001100,0b0011001100001100,0b0011000000001100,0b0000000000000000,0b0000000000000000}, // E
	{0b0011111111111100,0b0011111111111100,0b0011001100000000,0b0011001100000000,0b0011001100000000,0b0011000000000000,0b0000000000000000,0b0000000000000000}, // F
	{0b0001111111111000,0b0011111111111100,0b0011000000001100,0b0011000011001100,0b0011000011111100,0b0011000011111100,0b0000000000000000,0b0000000000000000}, // G
	{0b0011111111111100,0b0011111111111100,0b0000001100000000,0b0000001100000000,0b0011111111111100,0b0011111111111100,0b0000000000000000,0b0000000000000000}, // H
	{0b0011000000001100,0b0011000000001100,0b0011111111111100,0b0011111111111100,0b0011000000001100,0b0011000000001100,0b0000000000000000,0b0000000000000000}, // I
	{0b0000000000111000,0b0000000000111100,0b0000000000001100,0b0011000000001100,0b0011111111111100,0b0011111111111000,0b0000000000000000,0b0000000000000000}, // J
	{0b0011111111111100,0b0011111111111100,0b0000001111000000,0b0000111111110000,0b0011110000111100,0b0011000000001100,0b0000000000000000,0b0000000000000000}, // K
	{0b0011111111111100,0b0011111111111100,0b0000000000001100,0b0000000000001100,0b0000000000001100,0b0000000000001100,0b0000000000000000,0b0000000000000000}, // L
	{0b0011111111111100,0b0011111111111100,0b0000111100000000,0b0000001111000000,0b0000111100000000,0b0011111111111100,0b0011111111111100,0b0000000000000000}, // M
	{0b0011111111111100,0b0011111111111100,0b0000111111000000,0b0000001111110000,0b0011111111111100,0b0011111111111100,0b0000000000000000,0b0000000000000000}, // N
	{0b0001111111111000,0b0011111111111100,0b0011000000001100,0b0011000000001100,0b0011111111111100,0b0001111111111000,0b0000000000000000,0b0000000000000000}, // O
	{0b0011111111111100,0b0011111111111100,0b0011000011000000,0b0011000011000000,0b0011111111000000,0b0001111110000000,0b0000000000000000,0b0000000000000000}, // P
	{0b0001111111111000,0b0011111111111100,0b0011000000001100,0b0011000000111000,0b0011111111111100,0b0001111111101100,0b0000000000000000,0b0000000000000000}, // Q
	{0b0011111111111100,0b0011111111111100,0b0011000011000000,0b0011000011100000,0b0011111111111100,0b0001111110011100,0b0000000000000000,0b0000000000000000}, // R
	{0b0001111000001100,0b0011111100001100,0b0011001100001100,0b0011001100001100,0b0011001111111100,0b0011000111111000,0b0000000000000000,0b0000000000000000}, // S
	{0b0011000000000000,0b0011000000000000,0b0011111111111100,0b0011111111111100,0b0011000000000000,0b0011000000000000,0b0000000000000000,0b0000000000000000}, // T
	{0b0011111111111000,0b0011111111111100,0b0000000000001100,0b0000000000001100,0b0011111111111100,0b0011111111111000,0b0000000000000000,0b0000000000000000}, // U
	{0b0011111111100000,0b0011111111110000,0b0000000000111100,0b0000000000111100,0b0011111111110000,0b0011111111100000,0b0000000000000000,0b0000000000000000}, // V
	{0b0011111111111100,0b0011111111111100,0b0000000011110000,0b0000001111000000,0b0000000011110000,0b0011111111111100,0b0011111111111100,0b0000000000000000}, // W
	{0b0011000000011100,0b0011110001111100,0b0000111111100000,0b0000111111100000,0b0011110001111100,0b0011000000011100,0b0000000000000000,0b0000000000000000}, // X
	{0b0011111000000000,0b0011111100000000,0b0000001111111100,0b0000001111111100,0b0011111100000000,0b0011111000000000,0b0000000000000000,0b0000000000000000}, // Y
	{0b0011000000111100,0b0011000011111100,0b0011001111001100,0b0011111100001100,0b0011110000001100,0b0011000000001100,0b0000000000000000,0b0000000000000000}, // Z
	{0b0000000000000000,0b0000000000000000,0b0011111111111100,0b0011111111111100,0b0011000000001100,0b0011000000001100,0b0000000000000000,0b0000000000000000}, // [
	{0b0011000000000000,0b0011110000000000,0b0000111100000000,0b0000001111000000,0b0000000011110000,0b0000000000111100,0b0000000000001100,0b0000000000000000}, // \slash
	{0b0011000000001100,0b0011000000001100,0b0011111111111100,0b0011111111111100,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // ]
	{0b0000000011000000,0b0000001111000000,0b0000111100000000,0b0011110000000000,0b0000111100000000,0b0000001111000000,0b0000000011000000,0b0000000000000000}, // ^
	{0b0000000000001100,0b0000000000001100,0b0000000000001100,0b0000000000001100,0b0000000000001100,0b0000000000001100,0b0000000000001100,0b0000000000000000}, // _
	{0b0011100000000000,0b0001110000000000,0b0000111000000000,0b0000011100000000,0b0000000000000000,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // `
	{0b0000000001111000,0b0000110011111100,0b0000110011001100,0b0000110011001100,0b0000111111111100,0b0000011111111100,0b0000000000000000,0b0000000000000000}, // a
	{0b0011111111111100,0b0011111111111100,0b0000011000001100,0b0000011000001100,0b0000011111111100,0b0000001111111000,0b0000000000000000,0b0000000000000000}, // b
	{0b0000011111111000,0b0000111111111100,0b0000110000001100,0b0000110000001100,0b0000110000001100,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // c
	{0b0000001111111000,0b0000011111111100,0b0000011000001100,0b0000011000001100,0b0011111111111100,0b0011111111111100,0b0000000000000000,0b0000000000000000}, // d
	{0b0000011111111000,0b0000111111111100,0b0000110011001100,0b0000110011001100,0b0000111111001100,0b0000011111001100,0b0000000000000000,0b0000000000000000}, // e
	{0b0000000000000000,0b0000011000000000,0b0001111111111100,0b0011111111111100,0b0011011000000000,0b0011011000000000,0b0000000000000000,0b0000000000000000}, // f
	{0b0000011111100011,0b0000111111110011,0b0000110000110011,0b0000110000110011,0b0000111111111111,0b0000111111111110,0b0000000000000000,0b0000000000000000}, // g
	{0b0011111111111100,0b0011111111111100,0b0000011000000000,0b0000011000000000,0b0000011111111100,0b0000001111111100,0b0000000000000000,0b0000000000000000}, // h
	{0b0000000000000000,0b0000011000001100,0b0011011111111100,0b0011011111111100,0b0000000000001100,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // i
	{0b0000000000000000,0b0000000000000011,0b0000000000000011,0b0000000000000011,0b0011011111111111,0b0011011111111110,0b0000000000000000,0b0000000000000000}, // j
	{0b0011111111111100,0b0011111111111100,0b0000000111000000,0b0000011111110000,0b0000011000111100,0b0000000000001100,0b0000000000000000,0b0000000000000000}, // k
	{0b0000000000000000,0b0011000000001100,0b0011111111111100,0b0011111111111100,0b0000000000001100,0b0000000000000000,0b0000000000000000,0b0000000000000000}, // l
	{0b0000111111111100,0b0000111111111100,0b0000001111000000,0b0000000011110000,0b0000111111000000,0b0000111111111100,0b0000001111111100,0b0000000000000000}, // m
	{0b0000111111111100,0b0000111111111100,0b0000110000000000,0b0000110000000000,0b0000111111111100,0b0000011111111100,0b0000000000000000,0b0000000000000000}, // n
	{0b0000011111111000,0b0000111111111100,0b0000110000001100,0b0000110000001100,0b0000111111111100,0b0000011111111000,0b0000000000000000,0b0000000000000000}, // o
	{0b0000111111111111,0b0000111111111111,0b0000110000110000,0b0000110000110000,0b0000111111110000,0b0000011111100000,0b0000000000000000,0b0000000000000000}, // p
	{0b0000011111100000,0b0000111111110000,0b0000110000110000,0b0000110000110000,0b0000111111111111,0b0000011111111111,0b0000000000000000,0b0000000000000000}, // q
	{0b0000111111111100,0b0000111111111100,0b0000110000000000,0b0000110000000000,0b0000111100000000,0b0000011100000000,0b0000000000000000,0b0000000000000000}, // r
	{0b0000011110001100,0b0000111111001100,0b0000110011001100,0b0000110011001100,0b0000110011111100,0b0000110001111000,0b0000000000000000,0b0000000000000000}, // s
	{0b0000110000000000,0b0000110000000000,0b0011111111111000,0b0011111111111100,0b0000110000001100,0b0000110000001100,0b0000000000000000,0b0000000000000000}, // t
	{0b0000011111111111,0b0000011111111111,0b0000000000001100,0b0000000000001100,0b0000011111111100,0b0000011111111100,0b0000000000001100,0b0000000000000000}, // u
	{0b0000111111100000,0b0000111111110000,0b0000000000111100,0b0000000000111100,0b0000111111110000,0b0000111111100000,0b0000000000000000,0b0000000000000000}, // v
	{0b0000111111000000,0b0000111111111100,0b0000000011111100,0b0000001111110000,0b0000000011111100,0b0000111111111100,0b0000111111000000,0b0000000000000000}, // w
	{0b0000110000001100,0b0000111100111100,0b0000001111110000,0b0000001111110000,0b0000111100111100,0b0000110000001100,0b0000000000000000,0b0000000000000000}, // x
	{0b0000111111100011,0b0000111111110011,0b0000000000110011,0b0000000000111111,0b0000111111111110,0b0000111111111000,0b0000000000000000,0b0000000000000000}, // y
	{0b0000110000001100,0b0000110000111100,0b0000110011111100,0b0000111111001100,0b0000111100001100,0b0000110000001100,0b0000000000000000,0b0000000000000000}  // z
};

void wait(uint32_t duration) {
	volatile uint32_t dur = duration;
	uint32_t i = 0;
	for(i = 0; i < dur; i++);
}

// This is a generic 8080 16bit register write function (not actually specific to this LCD)
// If porting to a faster processor, you may need to add delays.
// See datasheet pg. 159 for timing requirements.
inline void write_lcd_register(uint16_t reg, uint16_t val){
	gpio_low(cs);			// assert CS line
	
	GPIOA->ODR = reg;		// specify the register number
	gpio_low(rs);			// RS low = specifying the register number
	gpio_low(wr);			// start write
	gpio_high(wr);			// end write

	GPIOA->ODR = val;		// specify the register value
	gpio_high(rs);			// RS high = specifying the register value
	gpio_low(wr);			// start write
	gpio_high(wr);			// end write
	
	gpio_high(cs);			// deassert CS line
}

uint16_t read_lcd_register(uint16_t reg) {
	uint16_t value = 0;

	gpio_low(cs);			// assert CS line
	GPIOA->ODR = reg;			// specify the register number
	gpio_low(rs);			// RS low = specifying the register number
	gpio_low(wr);			// start write
	gpio_high(wr);			// end write

	GPIOA->MODER = 0;			// all pins = input mode
	
	gpio_high(rs);			// RS high = requesting the register value
	
	gpio_low(rd);			// begin read
	value = GPIOA->IDR;			// read the value
	gpio_high(rd);			// end read

	gpio_low(rd);			// begin read
	value = GPIOA->IDR;			// read the value
	gpio_high(rd);			// end read
	
	gpio_high(cs);			// deassert CS line
	
	GPIOA->MODER = 0b01010101010101010101010101010101;	// all pins = output mode
	return value;
}

void write_lcd_pixel(uint16_t x, uint16_t y, uint16_t color) {
	write_lcd_register(0x20, x);
	write_lcd_register(0x21, y);
	write_lcd_register(0x22, color);
}

void write_lcd_char(uint16_t col, uint16_t row, char c) {
	uint16_t xoff = col*8;
	uint16_t yoff = row*16;
	for(uint8_t i = 0; i < 8; i++) {
		for(uint8_t bit = 0; bit < 16; bit++) {
			if(font_8x16[c-32][i] & (1 << 15-bit))
				write_lcd_pixel(xoff+i, yoff+bit, 0xFFFF);
			else
				write_lcd_pixel(xoff+i, yoff+bit, 0x0000);
		}
	}
}

void write_lcd_string(uint16_t x, uint16_t y, char string[]){
	uint8_t i = 0;
	while(string[i] != 0) {
		write_lcd_char(x+i, y, string[i]);
		i++;
	}
}

void lcd_tft1p4705_setup(	enum GPIO_PORT data_pins_port,
							enum GPIO_PIN cs_pin,
							enum GPIO_PIN rs_pin,
							enum GPIO_PIN wr_pin,
							enum GPIO_PIN rd_pin,
							enum GPIO_PIN reset_pin) {
	data_port = data_pins_port;
	cs = cs_pin;
	rs = rs_pin;
	wr = wr_pin;
	rd = rd_pin;
	reset = reset_pin;

	// setup GPIOs
	gpio_port_setup(data_port, OUTPUT, PUSH_PULL, TWO_MHZ, NO_PULL);
	gpio_setup(cs, OUTPUT, PUSH_PULL, TWO_MHZ, NO_PULL, AF0);
	gpio_setup(rs, OUTPUT, PUSH_PULL, TWO_MHZ, NO_PULL, AF0);
	gpio_setup(wr, OUTPUT, PUSH_PULL, TWO_MHZ, NO_PULL, AF0);
	gpio_setup(rd, OUTPUT, PUSH_PULL, TWO_MHZ, NO_PULL, AF0);
	gpio_setup(reset, OUTPUT, PUSH_PULL, TWO_MHZ, NO_PULL, AF0);

	// LCD reset sequence
	gpio_high(reset);
	wait(50000);
	gpio_low(reset);
	wait(50000);
	gpio_high(reset);
	gpio_high(cs);
	gpio_high(rd);
	gpio_high(wr);

	// LCD init
	write_lcd_register(0x0001, 0x003C); // portrait mode with (0,0) being the top left. top is the side opposite the LCD connector.
	write_lcd_register(0x0002, 0x0100);
	write_lcd_register(0x0003, 0x1030);
	write_lcd_register(0x0008, 0x0808);
	write_lcd_register(0x000A, 0x0500);
	write_lcd_register(0x000B, 0x0000);
	write_lcd_register(0x000C, 0x0770);
	write_lcd_register(0x000D, 0x0000);
	write_lcd_register(0x000E, 0x0001);
	write_lcd_register(0x0011, 0x0406);
	write_lcd_register(0x0012, 0x000E);
	write_lcd_register(0x0013, 0x0222);
	write_lcd_register(0x0014, 0x0015);
	write_lcd_register(0x0015, 0x4277);
	write_lcd_register(0x0016, 0x0000);
	write_lcd_register(0x0030, 0x6A50);
	write_lcd_register(0x0031, 0x00C9);
	write_lcd_register(0x0032, 0xC7BE);
	write_lcd_register(0x0033, 0x0003);
	write_lcd_register(0x0036, 0x3443);
	write_lcd_register(0x003B, 0x0000);
	write_lcd_register(0x003C, 0x0000);
	write_lcd_register(0x002C, 0x6A50);
	write_lcd_register(0x002D, 0x00C9);
	write_lcd_register(0x002E, 0xC7BE);
	write_lcd_register(0x002F, 0x0003);
	write_lcd_register(0x0035, 0x3443);
	write_lcd_register(0x0039, 0x0000);
	write_lcd_register(0x003A, 0x0000);
	write_lcd_register(0x0028, 0x6A50);
	write_lcd_register(0x0029, 0x00C9);
	write_lcd_register(0x002A, 0xC7BE);
	write_lcd_register(0x002B, 0x0003);
	write_lcd_register(0x0034, 0x3443);
	write_lcd_register(0x0037, 0x0000);
	write_lcd_register(0x0038, 0x0000);
	wait(50000);
	write_lcd_register(0x0012, 0x200E);
	wait(50000);
	write_lcd_register(0x0012, 0x2003);
	wait(50000);
	write_lcd_register(0x0044, 0x013F);
	write_lcd_register(0x0045, 0x0000);
	write_lcd_register(0x0046, 0x01DF);
	write_lcd_register(0x0047, 0x0000);
	write_lcd_register(0x0020, 0x0000);
	write_lcd_register(0x0021, 0x013F);
	write_lcd_register(0x0007, 0x0012);	
	wait(50000);
	write_lcd_register(0x0007, 0x0017);
	wait(50000);
}
